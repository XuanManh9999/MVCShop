<%- include("../layout/head.ejs", {title: "Th·ªëng K√™ ƒê∆°n H√†ng" })%>
    <%- include("../layout/header.ejs")%>
        <%- include("../layout/sidebar.ejs")%>

            <div class="col-sm-9 col-sm-offset-3 col-lg-10 col-lg-offset-2 main">
                <div class="row">
                    <ol class="breadcrumb">
                        <li><a href="#"><svg class="glyph stroked home">
                                    <use xlink:href="#stroked-home"></use>
                                </svg></a></li>
                        <li class="active">Th·ªëng k√™ ƒë∆°n h√†ng</li>
                    </ol>
                </div><!--/.row-->

                <div class="row">
                    <div class="col-lg-12">
                        <h1 class="page-header">Th·ªëng k√™ ƒë∆°n h√†ng</h1>
                    </div>
                </div><!--/.row-->

                <!-- B·ªô l·ªçc th·ªùi gian -->
                <div class="row">
                    <div class="col-lg-12">
                        <div class="panel panel-default">
                            <div class="panel-heading">
                                <svg class="glyph stroked calendar">
                                    <use xlink:href="#stroked-calendar"></use>
                                </svg> B·ªô l·ªçc th·ªùi gian
                            </div>
                            <div class="panel-body">
                                <form method="GET" action="/admin/statistics" class="form-inline">
                                    <div class="form-group" style="margin-right: 10px;">
                                        <label>Kho·∫£ng th·ªùi gian: </label>
                                        <select name="period" class="form-control" onchange="this.form.submit()"
                                            style="margin-left: 10px;">
                                            <option value="all" <%=period==='all' || !period ? 'selected' : '' %>>T·∫•t c·∫£
                                            </option>
                                            <option value="today" <%=period==='today' ? 'selected' : '' %>>H√¥m nay
                                            </option>
                                            <option value="week" <%=period==='week' ? 'selected' : '' %>>Tu·∫ßn n√†y
                                            </option>
                                            <option value="month" <%=period==='month' ? 'selected' : '' %>>Th√°ng n√†y
                                            </option>
                                            <option value="year" <%=period==='year' ? 'selected' : '' %>>NƒÉm nay
                                            </option>
                                        </select>
                                    </div>
                                    <div class="form-group" style="margin-right: 10px;">
                                        <label>T·ª´ ng√†y: </label>
                                        <input type="date" name="startDate" value="<%= startDate %>"
                                            class="form-control" style="margin-left: 10px;">
                                    </div>
                                    <div class="form-group" style="margin-right: 10px;">
                                        <label>ƒê·∫øn ng√†y: </label>
                                        <input type="date" name="endDate" value="<%= endDate %>" class="form-control"
                                            style="margin-left: 10px;">
                                    </div>
                                    <button type="submit" class="btn btn-primary">L·ªçc</button>
                                    <a href="/admin/statistics" class="btn btn-default">X√≥a b·ªô l·ªçc</a>
                                </form>
                                <p class="text-muted" style="margin-top: 10px;">
                                    <strong>Kho·∫£ng th·ªùi gian: </strong>
                                    <%= periodLabel %>
                                </p>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- T·ªïng quan -->
                <div class="row">
                    <div class="col-xs-12 col-md-6 col-lg-3">
                        <div class="panel panel-blue panel-widget">
                            <div class="row no-padding">
                                <div class="col-sm-3 col-lg-5 widget-left">
                                    <svg class="glyph stroked bag">
                                        <use xlink:href="#stroked-bag"></use>
                                    </svg>
                                </div>
                                <div class="col-sm-9 col-lg-7 widget-right">
                                    <div class="large">
                                        <%= totalOrders %>
                                    </div>
                                    <div class="text-muted">T·ªïng ƒë∆°n h√†ng</div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="col-xs-12 col-md-6 col-lg-3">
                        <div class="panel panel-green panel-widget">
                            <div class="row no-padding">
                                <div class="col-sm-3 col-lg-5 widget-left">
                                    <svg class="glyph stroked app-window-with-content">
                                        <use xlink:href="#stroked-app-window-with-content"></use>
                                    </svg>
                                </div>
                                <div class="col-sm-9 col-lg-7 widget-right">
                                    <div class="large">
                                        <%= (totalRevenue / 1000000).toFixed(1) %>M
                                    </div>
                                    <div class="text-muted" style="white-space: nowrap; font-size: 12px;">T·ªïng doanh thu
                                        (VNƒê)</div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="col-xs-12 col-md-6 col-lg-3">
                        <div class="panel panel-teal panel-widget">
                            <div class="row no-padding">
                                <div class="col-sm-3 col-lg-5 widget-left">
                                    <svg class="glyph stroked checkmark">
                                        <use xlink:href="#stroked-checkmark"></use>
                                    </svg>
                                </div>
                                <div class="col-sm-9 col-lg-7 widget-right">
                                    <div class="large">
                                        <%= paidOrders %>
                                    </div>
                                    <div class="text-muted">ƒê√£ thanh to√°n</div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="col-xs-12 col-md-6 col-lg-3">
                        <div class="panel panel-orange panel-widget">
                            <div class="row no-padding">
                                <div class="col-sm-3 col-lg-5 widget-left">
                                    <svg class="glyph stroked clock">
                                        <use xlink:href="#stroked-clock"></use>
                                    </svg>
                                </div>
                                <div class="col-sm-9 col-lg-7 widget-right">
                                    <div class="large">
                                        <%= unpaidOrders %>
                                    </div>
                                    <div class="text-muted">Ch∆∞a thanh to√°n</div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div><!--/.row-->

                <!-- Bi·ªÉu ƒë·ªì -->
                <div class="row">
                    <div class="col-lg-12">
                        <div class="panel panel-default">
                            <div class="panel-heading">
                                <svg class="glyph stroked line-graph">
                                    <use xlink:href="#stroked-line-graph"></use>
                                </svg> Bi·ªÉu ƒë·ªì doanh thu v√† ƒë∆°n h√†ng
                            </div>
                            <div class="panel-body" style="position: relative; height: 400px; overflow: hidden;">
                                <canvas id="revenueChart"></canvas>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Th·ªëng k√™ chi ti·∫øt -->
                <div class="row">
                    <!-- Th·ªëng k√™ theo tr·∫°ng th√°i -->
                    <div class="col-lg-6">
                        <div class="panel panel-default">
                            <div class="panel-heading">
                                <svg class="glyph stroked app-window-with-content">
                                    <use xlink:href="#stroked-app-window-with-content"></use>
                                </svg> Th·ªëng k√™ theo tr·∫°ng th√°i
                            </div>
                            <div class="panel-body">
                                <table class="table table-bordered">
                                    <thead>
                                        <tr>
                                            <th>Tr·∫°ng th√°i</th>
                                            <th>S·ªë l∆∞·ª£ng</th>
                                            <th>Doanh thu</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <% Object.keys(statusStats).forEach(status=> { %>
                                            <tr>
                                                <td>
                                                    <%= status %>
                                                </td>
                                                <td>
                                                    <%= statusStats[status].count %>
                                                </td>
                                                <td>
                                                    <%= statusStats[status].revenue.toLocaleString('vi-VN') %> ƒë
                                                </td>
                                            </tr>
                                            <% }) %>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>

                    <!-- Th·ªëng k√™ theo ph∆∞∆°ng th·ª©c thanh to√°n -->
                    <div class="col-lg-6">
                        <div class="panel panel-default">
                            <div class="panel-heading">
                                <svg class="glyph stroked app-window-with-content">
                                    <use xlink:href="#stroked-app-window-with-content"></use>
                                </svg> Th·ªëng k√™ theo ph∆∞∆°ng th·ª©c thanh to√°n
                            </div>
                            <div class="panel-body" style="position: relative; height: 300px; overflow: hidden;">
                                <canvas id="paymentChart"></canvas>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- S·∫£n ph·∫©m b√°n ch·∫°y -->
                <div class="row">
                    <div class="col-lg-12">
                        <div class="panel panel-default">
                            <div class="panel-heading">
                                <svg class="glyph stroked bag">
                                    <use xlink:href="#stroked-bag"></use>
                                </svg> Top 10 s·∫£n ph·∫©m b√°n ch·∫°y
                            </div>
                            <div class="panel-body">
                                <table class="table table-bordered table-hover">
                                    <thead>
                                        <tr>
                                            <th>STT</th>
                                            <th>T√™n s·∫£n ph·∫©m</th>
                                            <th>S·ªë l∆∞·ª£ng b√°n</th>
                                            <th>Doanh thu</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <% topProducts.forEach((product, index)=> { %>
                                            <tr>
                                                <td>
                                                    <%= index + 1 %>
                                                </td>
                                                <td>
                                                    <%= product.name %>
                                                </td>
                                                <td>
                                                    <%= product.quantity %>
                                                </td>
                                                <td>
                                                    <%= product.revenue.toLocaleString('vi-VN') %> ƒë
                                                </td>
                                            </tr>
                                            <% }) %>
                                                <% if (topProducts.length===0) { %>
                                                    <tr>
                                                        <td colspan="4" class="text-center">Ch∆∞a c√≥ d·ªØ li·ªáu</td>
                                                    </tr>
                                                    <% } %>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Kh√°ch h√†ng VIP -->
                <div class="row">
                    <div class="col-lg-12">
                        <div class="panel panel-default">
                            <div class="panel-heading">
                                <svg class="glyph stroked male-user">
                                    <use xlink:href="#stroked-male-user"></use>
                                </svg> Top 10 kh√°ch h√†ng VIP
                            </div>
                            <div class="panel-body">
                                <table class="table table-bordered table-hover">
                                    <thead>
                                        <tr>
                                            <th>STT</th>
                                            <th>T√™n kh√°ch h√†ng</th>
                                            <th>Email</th>
                                            <th>S·ªë ƒë∆°n h√†ng</th>
                                            <th>T·ªïng gi√° tr·ªã</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <% topCustomers.forEach((customer, index)=> { %>
                                            <tr>
                                                <td>
                                                    <%= index + 1 %>
                                                </td>
                                                <td>
                                                    <%= customer.name %>
                                                </td>
                                                <td>
                                                    <%= customer.email %>
                                                </td>
                                                <td>
                                                    <%= customer.orders %>
                                                </td>
                                                <td>
                                                    <%= customer.revenue.toLocaleString('vi-VN') %> ƒë
                                                </td>
                                            </tr>
                                            <% }) %>
                                                <% if (topCustomers.length===0) { %>
                                                    <tr>
                                                        <td colspan="5" class="text-center">Ch∆∞a c√≥ d·ªØ li·ªáu</td>
                                                    </tr>
                                                    <% } %>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- ƒê∆°n h√†ng g·∫ßn ƒë√¢y -->
                <div class="row">
                    <div class="col-lg-12">
                        <div class="panel panel-default">
                            <div class="panel-heading">
                                <svg class="glyph stroked clock">
                                    <use xlink:href="#stroked-clock"></use>
                                </svg> ƒê∆°n h√†ng g·∫ßn ƒë√¢y
                            </div>
                            <div class="panel-body">
                                <table class="table table-bordered table-hover">
                                    <thead>
                                        <tr>
                                            <th>STT</th>
                                            <th>Kh√°ch h√†ng</th>
                                            <th>Email</th>
                                            <th>Ng√†y ƒë·∫∑t</th>
                                            <th>T·ªïng ti·ªÅn</th>
                                            <th>Tr·∫°ng th√°i</th>
                                            <th>Thanh to√°n</th>
                                            <th>Chi ti·∫øt</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <% recentOrders.forEach((order, index)=> { %>
                                            <tr>
                                                <td>
                                                    <%= index + 1 %>
                                                </td>
                                                <td>
                                                    <%= order.name %>
                                                </td>
                                                <td>
                                                    <%= order.email %>
                                                </td>
                                                <td>
                                                    <%= moment(order.createdAt).format('DD/MM/YYYY HH:mm') %>
                                                </td>
                                                <td>
                                                    <%= order.total.toLocaleString('vi-VN') %> ƒë
                                                </td>
                                                <td>
                                                    <%= order.status %>
                                                </td>
                                                <td>
                                                    <% if (order.is_payment) { %>
                                                        <span class="label label-success">ƒê√£ thanh to√°n</span>
                                                        <% } else { %>
                                                            <span class="label label-warning">Ch∆∞a thanh to√°n</span>
                                                            <% } %>
                                                </td>
                                                <td>
                                                    <a href="/admin/orders/<%= order._id %>"
                                                        class="btn btn-info btn-sm">
                                                        <i class="glyphicon glyphicon-eye-open"></i>
                                                    </a>
                                                </td>
                                            </tr>
                                            <% }) %>
                                                <% if (recentOrders.length===0) { %>
                                                    <tr>
                                                        <td colspan="8" class="text-center">Ch∆∞a c√≥ ƒë∆°n h√†ng n√†o</td>
                                                    </tr>
                                                    <% } %>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
            </div><!--/.main-->

            <script src="js/jquery-1.11.1.min.js"></script>
            <script src="js/bootstrap.min.js"></script>
            <script src="js/chart.min.js"></script>
            <style>
                /* Fix layout cho bi·ªÉu ƒë·ªì - Responsive v√† kh√¥ng b·ªã v·ª° */
                #revenueChart {
                    max-width: 100%;
                    height: 100% !important;
                    width: 100% !important;
                }

                #paymentChart {
                    max-width: 100%;
                    height: 100% !important;
                    width: 100% !important;
                }

                .panel-body {
                    overflow: hidden;
                    position: relative;
                }

                /* ƒê·∫£m b·∫£o c√°c card kh√¥ng b·ªã v·ª° */
                .panel-widget {
                    min-height: 100px;
                }

                .panel-widget .large {
                    font-size: 2em;
                    font-weight: bold;
                    word-break: break-word;
                }

                /* Fix table responsive */
                .table {
                    width: 100%;
                    table-layout: auto;
                }

                .table th,
                .table td {
                    word-wrap: break-word;
                    overflow-wrap: break-word;
                }

                /* Responsive cho mobile */
                @media (max-width: 768px) {
                    .panel-body {
                        padding: 10px;
                    }

                    .panel-body[style*="height"] {
                        height: 300px !important;
                    }

                    .col-lg-6 {
                        margin-bottom: 20px;
                    }

                    .large {
                        font-size: 1.5em !important;
                    }

                    .text-muted {
                        font-size: 10px !important;
                    }
                }

                /* Fix cho bi·ªÉu ƒë·ªì tr√™n m√†n h√¨nh nh·ªè */
                @media (max-width: 480px) {
                    .panel-body[style*="height"] {
                        height: 250px !important;
                    }
                }
            </style>
            <script>
                // ƒê·ª£i DOM v√† Chart.js load xong
                (function () {
        // D·ªØ li·ªáu cho bi·ªÉu ƒë·ªì doanh thu - l·∫•y t·ª´ server (initial load)
        <% if (typeof dailyStats !== 'undefined' && dailyStats) { %>
        const initialDailyData = <%- JSON.stringify(dailyStats) %>;
        <% } else { %>
        const initialDailyData = [];
        <% } %>

        // D·ªØ li·ªáu ph∆∞∆°ng th·ª©c thanh to√°n - l·∫•y t·ª´ server (initial load)
        <% if (typeof paymentStats !== 'undefined' && paymentStats) { %>
        const initialPaymentStats = <%- JSON.stringify(paymentStats) %>;
        <% } else { %>
        const initialPaymentStats = { momo: { count: 0, revenue: 0 }, cash: { count: 0, revenue: 0 } };
        <% } %>

        // L∆∞u tr·ªØ d·ªØ li·ªáu hi·ªán t·∫°i
        let currentDailyData = initialDailyData;
        let currentPaymentStats = initialPaymentStats;

        // H√†m load d·ªØ li·ªáu t·ª´ API
        function loadChartData() {
            const form = document.querySelector('form[action="/admin/statistics"]');
            if (!form) return;

            const period = form.querySelector('select[name="period"]')?.value || 'all';
            const startDate = form.querySelector('input[name="startDate"]')?.value || '';
            const endDate = form.querySelector('input[name="endDate"]')?.value || '';

            // X√¢y d·ª±ng URL v·ªõi query params
            let url = '/admin/statistics/chart-data?type=daily';
            if (startDate && endDate) {
                url += '&startDate=' + encodeURIComponent(startDate) + '&endDate=' + encodeURIComponent(endDate);
            } else {
                url += '&period=' + encodeURIComponent(period);
            }

            console.log('üîÑ ƒêang load d·ªØ li·ªáu t·ª´ API:', url);

            fetch(url)
                .then(response => {
                    if (!response.ok) {
                        throw new Error('Network response was not ok');
                    }
                    return response.json();
                })
                .then(data => {
                    console.log('‚úÖ D·ªØ li·ªáu ƒë√£ load t·ª´ API:', data);
                    if (data.chartData) {
                        currentDailyData = data.chartData;
                    }
                    if (data.paymentStats) {
                        currentPaymentStats = data.paymentStats;
                    }
                    // C·∫≠p nh·∫≠t bi·ªÉu ƒë·ªì v·ªõi d·ªØ li·ªáu m·ªõi
                    updateCharts();
                })
                .catch(error => {
                    console.error('‚ùå L·ªói khi load d·ªØ li·ªáu t·ª´ API:', error);
                    // V·∫´n s·ª≠ d·ª•ng d·ªØ li·ªáu ban ƒë·∫ßu
                    updateCharts();
                });
        }

        // H√†m c·∫≠p nh·∫≠t bi·ªÉu ƒë·ªì v·ªõi d·ªØ li·ªáu hi·ªán t·∫°i
        function updateCharts() {
            console.log('üîÑ updateCharts ƒë∆∞·ª£c g·ªçi');
            console.log('üìä currentDailyData:', currentDailyData);
            console.log('üí≥ currentPaymentStats:', currentPaymentStats);
            
            if (typeof Chart === 'undefined') {
                console.error('‚ùå Chart.js ch∆∞a ƒë∆∞·ª£c load!');
                return;
            }

            const revenueCanvas = document.getElementById("revenueChart");
            const paymentCanvas = document.getElementById("paymentChart");

            if (!revenueCanvas) {
                console.error('‚ùå Canvas revenueChart kh√¥ng t·ªìn t·∫°i!');
            }
            if (!paymentCanvas) {
                console.error('‚ùå Canvas paymentChart kh√¥ng t·ªìn t·∫°i!');
            }
            if (!revenueCanvas || !paymentCanvas) {
                return;
            }

            // C·∫≠p nh·∫≠t bi·ªÉu ƒë·ªì doanh thu
            updateRevenueChart(revenueCanvas, currentDailyData);
            
            // C·∫≠p nh·∫≠t bi·ªÉu ƒë·ªì ph∆∞∆°ng th·ª©c thanh to√°n
            updatePaymentChart(paymentCanvas, currentPaymentStats);
        }

        // H√†m c·∫≠p nh·∫≠t bi·ªÉu ƒë·ªì doanh thu
        function updateRevenueChart(canvas, dailyData) {
            console.log('üìä updateRevenueChart ƒë∆∞·ª£c g·ªçi v·ªõi d·ªØ li·ªáu:', dailyData);
            
            let labels = [];
            let revenueData = [];
            let ordersData = [];

            if (dailyData && Array.isArray(dailyData) && dailyData.length > 0) {
                console.log('üìä C√≥ d·ªØ li·ªáu, s·ªë l∆∞·ª£ng:', dailyData.length);
                
                // S·∫Øp x·∫øp l·∫°i theo ng√†y
                const sortedData = dailyData.slice().sort((a, b) => {
                    // X·ª≠ l√Ω date format: c√≥ th·ªÉ l√† "YYYY-MM-DD" ho·∫∑c "DD/MM/YYYY"
                    let dateA, dateB;
                    if (a.date) {
                        dateA = new Date(a.date);
                    } else if (a.dateLabel) {
                        // Parse "DD/MM/YYYY" format
                        const parts = a.dateLabel.split('/');
                        if (parts.length === 3) {
                            dateA = new Date(parts[2], parts[1] - 1, parts[0]);
                        } else {
                            dateA = new Date(a.dateLabel);
                        }
                    } else {
                        dateA = new Date(0);
                    }
                    
                    if (b.date) {
                        dateB = new Date(b.date);
                    } else if (b.dateLabel) {
                        const parts = b.dateLabel.split('/');
                        if (parts.length === 3) {
                            dateB = new Date(parts[2], parts[1] - 1, parts[0]);
                        } else {
                            dateB = new Date(b.dateLabel);
                        }
                    } else {
                        dateB = new Date(0);
                    }
                    
                    return dateA - dateB;
                });

                labels = sortedData.map(item => {
                    // ƒê·∫£m b·∫£o label l√† string, kh√¥ng ph·∫£i object
                    let label = '';
                    if (item.dateLabel) {
                        label = String(item.dateLabel);
                    } else if (item.date) {
                        // Format date t·ª´ "YYYY-MM-DD" sang "DD/MM/YYYY"
                        const dateParts = String(item.date).split('-');
                        if (dateParts.length === 3) {
                            label = dateParts[2] + '/' + dateParts[1] + '/' + dateParts[0];
                        } else {
                            label = String(item.date);
                        }
                    }
                    return label || '';
                });
                
                revenueData = sortedData.map(item => {
                    const rev = parseFloat(item.revenue) || 0;
                    const result = parseFloat((rev / 1000000).toFixed(2));
                    return isNaN(result) ? 0 : result;
                });
                
                ordersData = sortedData.map(item => {
                    const ord = parseInt(item.orders) || 0;
                    return isNaN(ord) ? 0 : ord;
                });
                
                // ƒê·∫£m b·∫£o t·∫•t c·∫£ arrays c√≥ c√πng ƒë·ªô d√†i
                const maxLength = Math.max(labels.length, revenueData.length, ordersData.length);
                while (labels.length < maxLength) labels.push('');
                while (revenueData.length < maxLength) revenueData.push(0);
                while (ordersData.length < maxLength) ordersData.push(0);
                
                console.log('üìä D·ªØ li·ªáu ƒë√£ x·ª≠ l√Ω:', {
                    labels: labels,
                    labelsType: labels.map(l => typeof l),
                    revenueData: revenueData,
                    ordersData: ordersData,
                    sampleItem: sortedData[0]
                });
            } else {
                console.warn('‚ö†Ô∏è Kh√¥ng c√≥ d·ªØ li·ªáu ho·∫∑c d·ªØ li·ªáu kh√¥ng h·ª£p l·ªá');
                labels = ['Ch∆∞a c√≥ d·ªØ li·ªáu'];
                revenueData = [0];
                ordersData = [0];
            }
            
            // X·ª≠ l√Ω ƒë·∫∑c bi·ªát khi ch·ªâ c√≥ 1 ƒëi·ªÉm d·ªØ li·ªáu - Chart.js c·∫ßn √≠t nh·∫•t 2 ƒëi·ªÉm ƒë·ªÉ v·∫Ω ƒë∆∞·ªùng
            if (labels.length === 1 && labels[0] !== 'Ch∆∞a c√≥ d·ªØ li·ªáu') {
                console.log('üìä Ch·ªâ c√≥ 1 ƒëi·ªÉm d·ªØ li·ªáu, th√™m ƒëi·ªÉm th·ª© 2 ƒë·ªÉ Chart.js c√≥ th·ªÉ v·∫Ω');
                // Th√™m m·ªôt ƒëi·ªÉm tr∆∞·ªõc ƒë√≥ v·ªõi gi√° tr·ªã 0 ƒë·ªÉ bi·ªÉu ƒë·ªì c√≥ th·ªÉ v·∫Ω ƒë∆∞·ª£c
                const singleLabel = labels[0];
                const singleRevenue = revenueData[0];
                const singleOrders = ordersData[0];
                
                // T·∫°o label cho ƒëi·ªÉm tr∆∞·ªõc ƒë√≥ (ng√†y h√¥m tr∆∞·ªõc)
                let prevLabel = '';
                if (singleLabel.includes('/')) {
                    const parts = singleLabel.split('/');
                    if (parts.length === 3) {
                        const date = new Date(parts[2], parts[1] - 1, parts[0]);
                        date.setDate(date.getDate() - 1);
                        prevLabel = String(date.getDate()).padStart(2, '0') + '/' + 
                                   String(date.getMonth() + 1).padStart(2, '0') + '/' + 
                                   date.getFullYear();
                    } else {
                        prevLabel = singleLabel;
                    }
                } else {
                    prevLabel = singleLabel;
                }
                
                labels = [prevLabel, singleLabel];
                revenueData = [0, singleRevenue];
                ordersData = [0, singleOrders];
                
                console.log('üìä ƒê√£ th√™m ƒëi·ªÉm th·ª© 2:', {
                    labels: labels,
                    revenueData: revenueData,
                    ordersData: ordersData
                });
            }

            // ƒê·∫£m b·∫£o labels l√† array of strings
            const cleanLabels = labels.map((label, index) => {
                if (typeof label === 'object' && label !== null) {
                    console.warn('‚ö†Ô∏è Label t·∫°i index', index, 'l√† object:', label);
                    return String(label.dateLabel || label.date || label || '');
                }
                return String(label || '');
            });
            
            // ƒê·∫£m b·∫£o data l√† array of numbers
            const cleanRevenueData = revenueData.map((val, index) => {
                const num = typeof val === 'number' ? val : parseFloat(val) || 0;
                if (isNaN(num)) {
                    console.warn('‚ö†Ô∏è Revenue data t·∫°i index', index, 'kh√¥ng h·ª£p l·ªá:', val);
                    return 0;
                }
                return num;
            });
            
            const cleanOrdersData = ordersData.map((val, index) => {
                const num = typeof val === 'number' ? val : parseInt(val) || 0;
                if (isNaN(num)) {
                    console.warn('‚ö†Ô∏è Orders data t·∫°i index', index, 'kh√¥ng h·ª£p l·ªá:', val);
                    return 0;
                }
                return num;
            });
            
            console.log('üìä D·ªØ li·ªáu cu·ªëi c√πng tr∆∞·ªõc khi v·∫Ω:', {
                labels: cleanLabels,
                revenueData: cleanRevenueData,
                ordersData: cleanOrdersData
            });
            
            const lineChartData = {
                labels: cleanLabels,
                datasets: [
                    {
                        label: "Doanh thu (Tri·ªáu VNƒê)",
                        fillColor: "rgba(48, 164, 255, 0.2)",
                        strokeColor: "rgba(48, 164, 255, 1)",
                        pointColor: "rgba(48, 164, 255, 1)",
                        pointStrokeColor: "#fff",
                        pointHighlightFill: "#fff",
                        pointHighlightStroke: "rgba(48, 164, 255, 1)",
                        data: cleanRevenueData
                    },
                    {
                        label: "S·ªë ƒë∆°n h√†ng",
                        fillColor: "rgba(255, 181, 62, 0.2)",
                        strokeColor: "rgba(255, 181, 62, 1)",
                        pointColor: "rgba(255, 181, 62, 1)",
                        pointStrokeColor: "#fff",
                        pointHighlightFill: "#fff",
                        pointHighlightStroke: "rgba(255, 181, 62, 1)",
                        data: cleanOrdersData
                    }
                ]
            };

            try {
                const ctxRevenue = canvas.getContext("2d");
                if (!ctxRevenue) return;

                // Destroy chart c≈©
                if (window.myLine) {
                    try {
                        window.myLine.destroy();
                    } catch (e) {
                        console.warn('L·ªói khi destroy chart c≈©:', e);
                    }
                }

                // V·∫Ω bi·ªÉu ƒë·ªì m·ªõi
                window.myLine = new Chart(ctxRevenue).Line(lineChartData, {
                    responsive: true,
                    maintainAspectRatio: false,
                    scaleShowGridLines: true,
                    scaleGridLineColor: "rgba(0,0,0,.05)",
                    scaleGridLineWidth: 1,
                    bezierCurve: cleanLabels.length > 1 && cleanLabels[0] !== 'Ch∆∞a c√≥ d·ªØ li·ªáu',
                    bezierCurveTension: 0.4,
                    pointDot: cleanLabels.length <= 20,
                    pointDotRadius: cleanLabels.length > 15 ? 3 : 4,
                    pointDotStrokeWidth: 1,
                    pointHitDetectionRadius: 20,
                    datasetStroke: true,
                    datasetStrokeWidth: 2,
                    datasetFill: true,
                    scaleOverride: false,
                    scaleSteps: null,
                    scaleStepWidth: null,
                    scaleStartValue: 0,
                    scaleShowLabels: true,
                    scaleLabel: function (value) {
                        // Chart.js c√≥ th·ªÉ truy·ªÅn object ho·∫∑c number v√†o ƒë√¢y
                        // ƒê·∫£m b·∫£o lu√¥n tr·∫£ v·ªÅ string
                        try {
                            if (value === null || value === undefined) {
                                return '';
                            }
                            if (typeof value === 'object') {
                                // N·∫øu l√† object, l·∫•y gi√° tr·ªã s·ªë
                                if (value.value !== undefined) {
                                    return String(value.value);
                                }
                                if (value.label !== undefined) {
                                    return String(value.label);
                                }
                                // Fallback: convert to string
                                return String(value);
                            }
                            // N·∫øu l√† number ho·∫∑c string, convert sang string
                            return String(value);
                        } catch (e) {
                            console.warn('L·ªói trong scaleLabel:', e, 'value:', value);
                            return String(value || '');
                        }
                    },
                    multiTooltipTemplate: function (label) {
                        // ƒê·∫£m b·∫£o tooltip hi·ªÉn th·ªã ƒë√∫ng format
                        try {
                            if (!label) {
                                return '';
                            }
                            
                            let datasetLabel = '';
                            let value = '';
                            
                            if (typeof label === 'object') {
                                // Chart.js truy·ªÅn object v·ªõi c√°c thu·ªôc t√≠nh: datasetLabel, value, label, etc.
                                datasetLabel = String(label.datasetLabel || label.label || '');
                                
                                // X·ª≠ l√Ω value - c√≥ th·ªÉ l√† number ho·∫∑c object
                                if (label.value !== undefined && label.value !== null) {
                                    if (typeof label.value === 'object') {
                                        // N·∫øu value l√† object, l·∫•y gi√° tr·ªã s·ªë t·ª´ n√≥
                                        value = String(label.value.value || label.value.label || label.value || '');
                                    } else {
                                        // N·∫øu value l√† number ho·∫∑c string
                                        value = String(label.value);
                                    }
                                } else {
                                    value = '';
                                }
                            } else {
                                // N·∫øu label l√† string ho·∫∑c number
                                datasetLabel = String(label);
                                value = '';
                            }
                            
                            const result = datasetLabel + (value ? ": " + value : '');
                            return result;
                        } catch (e) {
                            console.warn('L·ªói trong multiTooltipTemplate:', e, 'label:', label);
                            return String(label || '');
                        }
                    }
                });

                console.log('‚úÖ Bi·ªÉu ƒë·ªì doanh thu ƒë√£ ƒë∆∞·ª£c c·∫≠p nh·∫≠t v·ªõi', labels.length, 'ƒëi·ªÉm d·ªØ li·ªáu');
            } catch (error) {
                console.error('‚ùå L·ªói v·∫Ω bi·ªÉu ƒë·ªì doanh thu:', error);
            }
        }

        // H√†m c·∫≠p nh·∫≠t bi·ªÉu ƒë·ªì ph∆∞∆°ng th·ª©c thanh to√°n
        function updatePaymentChart(canvas, paymentStatsData) {
            const momoCount = paymentStatsData.momo ? (paymentStatsData.momo.count || 0) : 0;
            const cashCount = paymentStatsData.cash ? (paymentStatsData.cash.count || 0) : 0;

            const paymentData = [];
            if (momoCount > 0) {
                paymentData.push({
                    value: momoCount,
                    color: "#30a5ff",
                    highlight: "#62b9fb",
                    label: "MoMo (" + momoCount + " ƒë∆°n)"
                });
            }
            if (cashCount > 0) {
                paymentData.push({
                    value: cashCount,
                    color: "#ffb53e",
                    highlight: "#fac878",
                    label: "Ti·ªÅn m·∫∑t (" + cashCount + " ƒë∆°n)"
                });
            }

            if (paymentData.length === 0) {
                paymentData.push({
                    value: 1,
                    color: "#cccccc",
                    highlight: "#dddddd",
                    label: "Ch∆∞a c√≥ d·ªØ li·ªáu"
                });
            }

            try {
                const ctxPayment = canvas.getContext("2d");
                if (!ctxPayment) return;

                // Destroy chart c≈©
                if (window.myDoughnut) {
                    try {
                        window.myDoughnut.destroy();
                    } catch (e) {
                        console.warn('L·ªói khi destroy payment chart c≈©:', e);
                    }
                }

                // V·∫Ω bi·ªÉu ƒë·ªì m·ªõi
                window.myDoughnut = new Chart(ctxPayment).Doughnut(paymentData, {
                    responsive: true,
                    maintainAspectRatio: true,
                    segmentShowStroke: true,
                    segmentStrokeColor: "#fff",
                    segmentStrokeWidth: 2,
                    percentageInnerCutout: 50,
                    animationSteps: 100,
                    animationEasing: "easeOutBounce",
                    animateRotate: true,
                    animateScale: false
                });

                console.log('‚úÖ Bi·ªÉu ƒë·ªì thanh to√°n ƒë√£ ƒë∆∞·ª£c c·∫≠p nh·∫≠t');
            } catch (error) {
                console.error('‚ùå L·ªói v·∫Ω bi·ªÉu ƒë·ªì thanh to√°n:', error);
            }
        }

        function initCharts() {
            // Kh·ªüi t·∫°o bi·ªÉu ƒë·ªì v·ªõi d·ªØ li·ªáu ban ƒë·∫ßu
            updateCharts();
        }

        // Ch·ªù DOM v√† Chart.js s·∫µn s√†ng
        function waitForChart() {
            if (typeof Chart !== 'undefined' && typeof Chart.prototype !== 'undefined' && typeof Chart.prototype.Line !== 'undefined' && typeof Chart.prototype.Doughnut !== 'undefined') {
                // Chart.js ƒë√£ s·∫µn s√†ng, kh·ªüi t·∫°o bi·ªÉu ƒë·ªì
                console.log('‚úÖ Chart.js ƒë√£ s·∫µn s√†ng (Line v√† Doughnut), b·∫Øt ƒë·∫ßu kh·ªüi t·∫°o bi·ªÉu ƒë·ªì...');
                setTimeout(initCharts, 100);
            } else {
                console.log('‚è≥ ƒêang ch·ªù Chart.js load...');
                console.log('‚è≥ Chart:', typeof Chart);
                console.log('‚è≥ Chart.prototype:', typeof Chart.prototype);
                console.log('‚è≥ Chart.prototype.Line:', typeof Chart.prototype.Line);
                console.log('‚è≥ Chart.prototype.Doughnut:', typeof Chart.prototype.Doughnut);
                setTimeout(waitForChart, 100);
            }
        }

        // B·∫Øt ƒë·∫ßu ch·ªù sau khi DOM s·∫µn s√†ng
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', function () {
                console.log('üìÑ DOM ƒë√£ s·∫µn s√†ng, ch·ªù Chart.js...');
                setTimeout(waitForChart, 500);
            });
        } else {
            console.log('üìÑ DOM ƒë√£ s·∫µn s√†ng, ch·ªù Chart.js...');
            setTimeout(waitForChart, 500);
        }

        // L·∫Øng nghe s·ª± ki·ªán submit form ƒë·ªÉ load d·ªØ li·ªáu m·ªõi (AJAX - optional)
        // Note: Form s·∫Ω submit b√¨nh th∆∞·ªùng v√† reload trang, d·ªØ li·ªáu m·ªõi s·∫Ω ƒë∆∞·ª£c t√≠nh to√°n t·ª´ server
        // Code n√†y ch·ªâ ƒë·ªÉ c·∫£i thi·ªán UX n·∫øu mu·ªën load d·ªØ li·ªáu ƒë·ªông m√† kh√¥ng reload trang
        const filterForm = document.querySelector('form[action="/admin/statistics"]');
        if (filterForm) {
            // T√πy ch·ªçn: Load d·ªØ li·ªáu ƒë·ªông khi filter thay ƒë·ªïi (kh√¥ng reload trang)
            // ƒê·ªÉ s·ª≠ d·ª•ng, uncomment code b√™n d∆∞·ªõi v√† comment out onchange="this.form.submit()" trong HTML
            /*
            const periodSelect = filterForm.querySelector('select[name="period"]');
            if (periodSelect) {
                // X√≥a onchange c≈©
                periodSelect.removeAttribute('onchange');
                periodSelect.addEventListener('change', function() {
                    loadChartData();
                });
            }
            */
        }
                })();
            </script>

            <%- include("../layout/footer.ejs")%>